/**
 * Core Philosophy: This ruleset implements a Role-Based Access Control (RBAC) system combined with a user-ownership model.
 * There are two primary roles: 'student' (default) and 'admin'. Administrator privileges are granted by the existence
 * of a document in the `/roles_admin` collection, providing a fast and secure way to check for elevated permissions.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user profile data. Each document is strictly owned by the corresponding user but can also be managed by administrators.
 * - /users/{userId}/results/{resultId}: Stores test results for a specific user. This data is private and only accessible by the owner.
 * - /questions/{questionId}: A global collection of all questions. This data is managed exclusively by administrators, but is readable by any authenticated user (e.g., students taking a test).
 * - /tests/{testId}: A global collection of test configurations. Managed by admins, but readable by any authenticated user.
 * - /roles_admin/{userId}: A private, server-managed collection used as a lookup table to identify administrators. Client-side access is completely denied to prevent enumeration of admins.
 *
 * Key Security Decisions:
 * - Admin Role Management: The `/roles_admin` collection is not writable by any client. Adding or removing administrators must be done through a trusted server environment (like the Firebase Console or Cloud Functions) to ensure maximum security.
 * - User Data Privacy: User data in `/users/{userId}` and their results in subcollections are protected. A user can only access their own documents. Administrators are granted read access for management purposes but cannot write to prevent accidental data corruption. Listing users is explicitly disabled to prevent data leakage.
 * - Content Management: All question and test content is managed by administrators, ensuring data integrity. Any authenticated user can read this data.
 * - Default Posture: The default security posture is to deny access unless explicitly granted. Any operation not covered by an `allow` rule will fail.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the user has an admin role.
     * Checks for the existence of a document in the roles_admin collection.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Returns true if the currently authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * Returns true if the document being accessed already exists in Firestore.
     */
    function isExistingDoc() {
      return resource != null;
    }
    
    // --------------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------------

    /**
     * @description Questions are managed by admins but readable by any signed-in user.
     * @path /questions/{questionId}
     */
    match /questions/{questionId} {
      allow get, list: if isSignedIn();
      // Admins have full write access (create, update, delete).
      // This simplifies batch uploads from the client.
      allow write: if isAdmin();
    }
    
    /**
     * @description Tests are managed by admins but readable by any signed-in user.
     * @path /tests/{testId}
     */
    match /tests/{testId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin();
    }

    /**
     * @description User profiles and their subcollections.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if (isOwner(userId) || isAdmin()) && isExistingDoc() && request.resource.data.uid == resource.data.id;
      allow delete: if (isOwner(userId) || isAdmin()) && isExistingDoc();
      
      /**
       * @description A user's test results are private to them.
       * @path /users/{userId}/results/{resultId}
       */
      match /results/{resultId} {
        allow read, list, create: if isOwner(userId);
        allow update, delete: if false; // Results are immutable
      }
    }

    /**
     * @description A private collection to grant admin roles. Not accessible by clients.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      allow read, write: if false;
    }
  }
}
